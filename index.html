<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PME Application</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">

  <!-- PDF.js (free, global build) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

  <!-- Shared deterministic features + ranker -->
  <script src="./features.js"></script>
  <script src="./rank.js"></script>

  <style>
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Montserrat, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:#f6f6f9;
      color:#0b1220;
    }

    :root{
      --container: 1060px;
      --padX: 22px;

      /* PME purple */
      --pme-purple: #6d4cff;
      --pme-purple-2: #a855f7;

      --ink: rgba(17,10,35,.92);
      --muted: rgba(17,10,35,.70);

      --border: rgba(17,10,35,.16);
      --border2: rgba(109,76,255,.30);

      --card-bg: #ffffff;
      --shadow: 0 10px 26px rgba(17,10,35,.06);

      /* BLOCKY: hard corners */
      --r: 0px;

      --ease: cubic-bezier(0.22, 1, 0.36, 1);

      /* NEW: hero bg (flat, light purple) */
      --hero-bg: #eadcff;
    }

    .wrap{ max-width: var(--container); margin: 0 auto; padding: 18px var(--padX) 90px; }

    /* HERO STRIP (flat color + logo) */
    .hero-strip{
      background: var(--hero-bg);
      color: var(--ink);
      padding: 22px var(--padX);
      border-bottom: 0px solid rgba(17,10,35,.10);
    }
    .hero-inner{
      max-width: var(--container);
      margin: 0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 18px;
    }
    .hero-left{ min-width: 0; }
    .kicker{
      font-size: 12px;
      letter-spacing: .16em;
      text-transform: uppercase;
      font-weight: 800;
      color: var(--pme-purple);
      opacity: 1;
    }
    h1{
      margin: 10px 0 0;
      font-size: clamp(30px, 3.2vw, 46px);
      letter-spacing: -0.03em;
      font-weight: 800;
      line-height: 1.02;
      color: var(--ink);
    }
    .hero-logo{
      width: 90px;
      height: 90px;
      object-fit: contain;
      flex: 0 0 auto;
      filter: drop-shadow(0 10px 18px rgba(17,10,35,.10));
    }
    @media (max-width: 640px){
      .hero-logo{ width: 72px; height: 72px; }
    }

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 16px;
      margin-top: 18px;
    }

    /* BLOCK CARDS */
    .card{
      border: 2px solid rgba(17,10,35,.12);
      background: var(--card-bg);
      border-radius: var(--r);
      padding: 18px;
      box-shadow: var(--shadow);
    }

    .card-title{
      margin: 0 0 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .card-title h2{
      margin:0;
      font-size: 14px;
      font-weight: 900;
      letter-spacing: .14em;
      text-transform: uppercase;
      color: rgba(17,10,35,.86);
    }

    /* REMOVE the top-right tags entirely by not rendering them in HTML.
       (If any remain by accident, hide them.) */
    .tag{ display:none; }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      align-items:start;
    }
    @media (max-width: 900px){
      .row{ grid-template-columns: 1fr; }
    }

    label{
      display:block;
      font-size: 11px;
      letter-spacing:.14em;
      text-transform: uppercase;
      color: rgba(17,10,35,.72);
      margin: 14px 0 8px;
      font-weight: 900;
    }

    /* Make text inputs + selects the SAME HEIGHT */
    input, select{
      width:100%;
      height: 52px;
      padding: 12px 12px;
      border: 2px solid rgba(17,10,35,.16);
      border-radius: var(--r);
      font-family: inherit;
      font-size: 14px;
      outline: none;
      background:#fff;
      transition: border-color 180ms var(--ease), box-shadow 180ms var(--ease);
      line-height: 1.2;
      -webkit-appearance: none;
      appearance: none;
    }
    textarea{
      width:100%;
      padding: 12px 12px;
      border: 2px solid rgba(17,10,35,.16);
      border-radius: var(--r);
      font-family: inherit;
      font-size: 14px;
      outline: none;
      background:#fff;
      transition: border-color 180ms var(--ease), box-shadow 180ms var(--ease);
      min-height: 120px;
      resize: vertical;
      line-height:1.6;
    }

    input:focus, select:focus, textarea:focus{
      border-color: rgba(109,76,255,.85);
      box-shadow: 0 0 0 3px rgba(109,76,255,.18);
    }

    .note{
      margin: 10px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height:1.65;
    }

    .rule{
      height: 2px;
      background: rgba(17,10,35,.08);
      margin: 16px 0 10px;
    }

    /* Course mark UI (button stays inline with the input; hint goes BELOW) */
    .course-row{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
    }
    @media (max-width: 640px){
      .course-row{ grid-template-columns: 1fr; }
    }
    .course-hint{
      font-size: 12px;
      color: rgba(17,10,35,.70);
      line-height:1.6;
      margin-top: 10px;
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      background: rgba(17,10,35,.04);
      border: 2px solid rgba(17,10,35,.10);
      border-radius: var(--r);
      padding: 2px 6px;
    }

    .btn{
      appearance:none;
      border: 2px solid rgba(17,10,35,.16);
      cursor:pointer;
      font-family: inherit;
      border-radius: var(--r);
      padding: 16px 20px;
      font-weight: 900;
      letter-spacing: .14em;
      text-transform: uppercase;
      font-size: 12px;
      user-select:none;
      white-space:nowrap;
      background:#fff;
      color: rgba(17,10,35,.92);
      transition: none; /* remove hover animation */
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    /* No gradients on buttons (keep it clean + consistent) */
    .btn-primary{
      background: #eadcff;
      border-color: #eadcff;
      border: 0;
      color:#000000;
    }
    .btn-ghost{
      background: rgba(17,10,35,.06);
      border-color: rgba(17,10,35,.14);
      border: 0;
      color: rgba(17,10,35,.92);
    }

    /* Chips */
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      margin-top: 12px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 12px 14px;
      border-radius: var(--r);
      border: 0px solid rgba(109,76,255,.30);
      background: rgba(109,76,255,.10);
      color: rgba(17,10,35,.92);
      font-size: 12px;
      letter-spacing: .06em;
      font-weight: 800;
    }
    .chip button{
      border:0;
      background: transparent;
      cursor: pointer;
      font-weight: 900;
      font-size: 14px;
      line-height: 1;
      padding: 0;
      color: rgba(17,10,35,.80);
    }

    /* Actions/status */
    .actions{
      display:flex;
      gap: 10px;
      margin-top: 16px;
      flex-wrap:wrap;
      align-items:center;
    }
    .status{
      font-size: 13px;
      color: rgba(17,10,35,.82);
      margin-left: 2px;
    }
    .status.muted{ color: var(--muted); }

    /* Results */
    .results{
      margin-top: 14px;
      padding: 16px;
      border-radius: var(--r);
      background: #fff;
      border: 2px solid rgba(109,76,255,.30);
    }
    .big{
      font-size: 46px;
      font-weight: 900;
      letter-spacing:-0.02em;
      margin: 0;
      color: rgba(17,10,35,.92);
    }
    .pill{
      display:inline-flex;
      align-items:center;
      padding: 8px 10px;
      border-radius: var(--r);
      font-size: 12px;
      letter-spacing:.14em;
      text-transform: uppercase;
      font-weight: 900;
      border: 2px solid rgba(17,10,35,.16);
      background: rgba(17,10,35,.04);
      margin-top: 10px;
      color: rgba(17,10,35,.90);
    }

    .breakdown{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 900px){
      .breakdown{ grid-template-columns: 1fr; }
    }
    .bd{
      background:#fff;
      border: 2px solid rgba(17,10,35,.12);
      border-radius: var(--r);
      padding: 10px 12px;
      font-size: 13px;
      color: rgba(17,10,35,.86);
    }
    .bd strong{ font-weight: 900; }

    .tiny{
      font-size: 12px;
      color: var(--muted);
      line-height:1.65;
      margin-top: 10px;
    }

    .err{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: var(--r);
      background: rgba(220,38,38,.06);
      border: 2px solid rgba(220,38,38,.22);
      color: rgba(127,29,29,.92);
      font-size: 13px;
      line-height: 1.55;
    }
  </style>
</head>

<body>
  <div class="hero-strip">
    <div class="hero-inner">
      <div class="hero-left">
        <div class="kicker">Columbia Pi Mu Epsilon</div>
        <h1>Application</h1>
      </div>

      <!-- Put pmelogo.png in /public so this loads -->
      <img class="hero-logo" src="./pmelogo.png" alt="Pi Mu Epsilon seal" />
    </div>
  </div>

  <div class="wrap">
    <div class="grid">

      <!-- CARD 1: Applicant Information -->
      <div class="card">
        <div class="card-title">
          <h2>Applicant Information</h2>
        </div>

        <div class="row">
          <div>
            <label for="fullName">Full Name</label>
            <input id="fullName" placeholder="First Last" autocomplete="name"/>
          </div>
          <div>
            <label for="uni">UNI</label>
            <input id="uni" placeholder="abc1234" autocomplete="username"/>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="email">Email</label>
            <input id="email" type="email" placeholder="abc1234@columbia.edu" autocomplete="email"/>
            <p class="note">Use your Columbia/Barnard email if you have one.</p>
          </div>
          <div>
              <label for="schoolYearText">School (Year)</label>
              <input id="schoolYearText" placeholder="CC (2026)" />
              <p class="note">Example formats: <span class="mono">CC (2027)</span> or <span class="mono">Barnard (2026)</span>.</p>          </div>
        </div>

        <label for="raceEth">Race / Ethnicity (Optional)</label>
        <select id="raceEth">
          <option value="">Select</option>
          <option value="American Indian or Alaska Native">American Indian or Alaska Native</option>
          <option value="Asian">Asian</option>
          <option value="Black or African American">Black or African American</option>
          <option value="Hispanic or Latino">Hispanic or Latino</option>
          <option value="Middle Eastern or North African">Middle Eastern or North African</option>
          <option value="Native Hawaiian or Other Pacific Islander">Native Hawaiian or Other Pacific Islander</option>
          <option value="White">White</option>
          <option value="Multiracial">Multiracial</option>
          <option value="Other">Other</option>
          <option value="Prefer not to say">Prefer not to say</option>
        </select>
        <p class="note">
          Optional. Used only to understand the composition of our applicant pool and support inclusive programming.
        </p>
      </div>

      <!-- CARD 2: Eligibility Signals -->
      <div class="card">
        <div class="card-title">
          <h2>Eligibility Criteria</h2>
        </div>

        <div class="row">
          <div>
            <label for="gpa">Cumulative GPA (0.00–4.00)</label>
            <input id="gpa" type="number" min="0" max="4.33" step="0.01" placeholder="3.78" />
            <p class="note">Columbia GPAs can exceed 4.0 due to A+ (up to ~4.33).</p>
          </div>

          <div>
            <label for="calc">Completed Calculus I &amp; II (or equivalent)?</label>
            <select id="calc">
              <option value="">Select</option>
              <option value="yes">Yes</option>
              <option value="no">No</option>
            </select>
            <p class="note">Binary eligibility signal.</p>
          </div>
        </div>

        <div class="rule"></div>

        <label>Advanced / Recent Math-related Coursework (mark up to 6)</label>
        <div class="course-row">
          <input id="courseInput" placeholder="MATH GU4061 (or MATH GR6xxx)" />
          <button class="btn btn-primary" id="btnMarkCourse" type="button">Mark Course</button>
        </div>

        <div class="course-hint">
          We count a course if it appears in our bulletin database or if it is graduate-level <span class="mono">MATH GR5xxx/6xxx</span>.
        </div>

        <div id="courseChips" class="chips" aria-label="Selected courses"></div>
        <p class="note" id="courseCountNote">0 / 6 courses marked.</p>
        <div id="courseErr" class="err" style="display:none;"></div>
      </div>

      <!-- CARD 3: Materials + Short Answers -->
      <div class="card">
        <div class="card-title">
          <h2>Application Materials</h2>
        </div>

          <label for="resume">ML Scoring (resume upload)</label>
          <input id="resume" type="file" accept="application/pdf" style="height:auto; padding: 12px;" />
          <p class="note">
            PDF is used for scoring only given present formulations in the model utilized for delivering first-round scores. Reviewers need not review resumes during the first round in the aim of preserving maximal fairness and maximal perspective.
          </p>

          <div class="rule"></div>

          <h3 style="margin:0; font-size:12px; letter-spacing:.14em; text-transform:uppercase; font-weight:900; color:rgba(17,10,35,.72);">
            Resume upload (PDF)
          </h3>
          <div style="margin-top:10px;">
            <iframe
              src="https://docs.google.com/forms/d/e/1FAIpQLSdwFqaToBSrh5zDbdMNbTi-LUoS2wxcQHBRkplWqr-pSZZ8kQ/viewform?embedded=true"
              width="100%"
              height="260"
              frameborder="0"
              marginheight="0"
              marginwidth="0"
            >Loading…</iframe>
          </div>
        <div class="rule"></div>

<label for="essayMath">Short Answer A (2–4 sentences)</label>
<textarea id="essayMath"
          maxlength="1800"
          data-max-words="250"
          placeholder="Tell us one experience that shaped how you approach math (a challenge, turning point, or moment you earned confidence). What did it change about how you learn or persist?"></textarea>
<div class="note" id="essayMathCount">0 / 250 words</div>

<label for="essayCommunity">Short Answer B (2–4 sentences)</label>
<textarea id="essayCommunity"
          maxlength="1800"
          data-max-words="250"
          placeholder="Describe one mathematical idea you find compelling and the key insight. Then name one specific way you’d contribute to PME this semester tied to that interest (talk, problem session, reading group, outreach)."></textarea>
<div class="note" id="essayCommunityCount">0 / 250 words</div>
        <div class="rule"></div>

        <label for="poolFile">Optional: applicants.jsonl (pool calibration)</label>
        <input id="poolFile" type="file" accept=".jsonl,text/plain" style="height:auto; padding: 12px;" />
        <p class="note">Upload a pool file to convert raw score into a percentile-based 0–10 score.</p>

        <div class="actions">
          <button class="btn btn-primary" id="btnScore" type="button">Calculate Score</button>
          <button class="btn btn-ghost" id="btnReset" type="button">Reset</button>
          <span id="status" class="status muted"></span>
        </div>

        <div id="out" class="results" style="display:none;"></div>
      </div>

    </div>
  </div>

<script>
/* ==========================================
   PME Application — single drop-in <script>
   FIXED + CONSISTENT:
   - Essays are sent as: essayMath, essayCommunity (verbatim)
   - Word counts sent as: essayMath_words, essayCommunity_words
   - No counter IDs referenced anywhere (we update the .note right after each textarea)
   - UNI live redflag: >10 chars OR contains @ OR ANY whitespace (instant)
   - Email live redflag: must end with @columbia.edu or @barnard.edu
   - btnScore disabled until UNI+Email valid
   - Resume must be 1–2 pages (checked via PDF.js)
   - Reset always clickable (we do NOT disable it)
   ========================================== */

(() => {
  // ==========================
  // Google Sheets (Apps Script)
  // ==========================
  const SHEETS_ENDPOINT =
    "https://script.google.com/a/macros/columbia.edu/s/AKfycbyTK4l9KiEgbWMeib4GjnMfI3mX0t9hjb9SYzNTjUH_5ASi3dbtav0saQSe__UPP9e7/exec";

  async function saveSubmissionToSheet(payload) {
    const body = JSON.stringify(payload);

    // Beacon only for small payloads; otherwise fetch.
    const BEACON_MAX = 45000;
    const canBeacon = body.length <= BEACON_MAX;

    if (canBeacon && navigator.sendBeacon) {
      const ok = navigator.sendBeacon(
        SHEETS_ENDPOINT,
        new Blob([body], { type: "text/plain;charset=utf-8" })
      );
      if (ok) return;
    }

    // Always attempt fetch (best effort, fire-and-forget).
    await fetch(SHEETS_ENDPOINT + "?ts=" + Date.now(), {
      method: "POST",
      mode: "no-cors",
      keepalive: true,
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body
    });
  }

  // ==========================
  // Helpers / UI
  // ==========================
  const el = (id) => document.getElementById(id);

  function setStatus(msg, muted = true) {
    const s = el("status");
    if (!s) return;
    s.textContent = msg || "";
    s.classList.toggle("muted", !!muted);
  }

  // IMPORTANT: keep Reset clickable always
  function disableUI(isBusy) {
    const score = el("btnScore");
    const mark  = el("btnMarkCourse");
    if (score) score.disabled = !!isBusy || !isScoreButtonAllowed();
    if (mark)  mark.disabled  = !!isBusy || (Array.isArray(markedCourses) && markedCourses.length >= MAX_COURSES);
  }

  function escapeHtml(s = "") {
    return String(s)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function showOutError(lines) {
    const out = el("out");
    if (!out) return;
    const arr = Array.isArray(lines) ? lines : [String(lines || "")];
    out.style.display = "block";
    out.innerHTML =
      `<div class="err"><strong>Fix these first</strong><br>` +
      arr.map((f) => `• ${escapeHtml(f)}`).join("<br>") +
      `</div>`;
  }

  function clearOut() {
    const out = el("out");
    if (!out) return;
    out.style.display = "none";
    out.innerHTML = "";
  }

  // ==========================
  // UNI + Email live validation
  // ==========================
  function setFieldError(node, on) {
    if (!node) return;
    node.style.borderColor = on ? "rgba(220,38,38,.85)" : "";
    node.style.boxShadow   = on ? "0 0 0 3px rgba(220,38,38,.18)" : "";
  }

  function validateUNI() {
    const uniEl = el("uni");
    if (!uniEl) return { ok: true, value: "", bad: false };

    const raw = String(uniEl.value || "");

    // instant redflag on ANY whitespace, length > 10, or contains '@'
    const bad = raw.length > 10 || raw.includes("@") || /\s/.test(raw);

    setFieldError(uniEl, bad);

    const value = raw.trim();
    return { ok: !bad && value.length > 0, value, bad };
  }

  function validateEmail() {
    const emailEl = el("email");
    if (!emailEl) return { ok: true, value: "", bad: false };

    const raw = String(emailEl.value || "").trim().toLowerCase();
    const okDomain = raw.endsWith("@columbia.edu") || raw.endsWith("@barnard.edu");
    const bad = raw.length > 0 && !okDomain;

    setFieldError(emailEl, bad);

    return { ok: okDomain && raw.length > 0, value: raw, bad };
  }

  function isScoreButtonAllowed() {
    const u = validateUNI();
    const e = validateEmail();
    return u.ok && e.ok;
  }

  function updateScoreButtonEnabled() {
    const btn = el("btnScore");
    if (!btn) return;
    btn.disabled = !isScoreButtonAllowed();
  }

  function wireUniEmailValidation() {
    const uniEl = el("uni");
    const emailEl = el("email");

    if (uniEl) {
      uniEl.addEventListener("input", () => { validateUNI(); updateScoreButtonEnabled(); });
      uniEl.addEventListener("blur",  () => { validateUNI(); updateScoreButtonEnabled(); });
    }
    if (emailEl) {
      emailEl.addEventListener("input", () => { validateEmail(); updateScoreButtonEnabled(); });
      emailEl.addEventListener("blur",  () => { validateEmail(); updateScoreButtonEnabled(); });
    }
    updateScoreButtonEnabled();
  }

  // ==========================
  // Word limits (Short Answers)
  // Uses ONLY textarea IDs: essayMath, essayCommunity
  // Updates the existing .note that is placed right after each textarea
  // ==========================
  function splitWords(text) {
    const t = String(text || "").trim();
    if (!t) return [];
    return t.split(/\s+/g).filter(Boolean);
  }
  function wordCount(text) {
    return splitWords(text).length;
  }
  function enforceWordCap(textarea, maxWords) {
    if (!textarea) return;
    const words = splitWords(textarea.value);
    if (words.length <= maxWords) return;
    textarea.value = words.slice(0, maxWords).join(" ") + " ";
  }
  function getMaxWords(textarea, fallback = 250) {
    const raw = textarea?.dataset?.maxWords;
    const n = Number(raw);
    return Number.isFinite(n) && n > 0 ? n : fallback;
  }
  function getNoteNodeAfterTextarea(textarea) {
    if (!textarea) return null;
    const next = textarea.nextElementSibling;
    if (next && next.classList && next.classList.contains("note")) return next;
    return null; // user already has a .note in your HTML; if missing, we just skip
  }
  function updateTextareaNote(textarea) {
    if (!textarea) return;
    const maxWords = getMaxWords(textarea, 250);
    enforceWordCap(textarea, maxWords);
    const wc = wordCount(textarea.value);
    const note = getNoteNodeAfterTextarea(textarea);
    if (note) note.textContent = `${wc} / ${maxWords} words`;
  }
  function wireWordLimit(textareaId) {
    const ta = el(textareaId);
    if (!ta) return;

    const render = () => updateTextareaNote(ta);

    ta.addEventListener("input", render);
    ta.addEventListener("paste", () => setTimeout(render, 0));

    render();
  }

  // ==========================
  // PDF.js helpers (resume pages + text)
  // ==========================
  function getPdfjs() {
    if (window.pdfjsLib) return window.pdfjsLib;
    throw new Error("PDF.js failed to load (pdfjsLib not found).");
  }

  function ensurePdfWorker(pdfjs) {
    pdfjs.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
  }

  async function getPdfPageCount(file) {
    if (!file) return 0;
    const buf = await file.arrayBuffer();
    const pdfjs = getPdfjs();
    ensurePdfWorker(pdfjs);
    const pdf = await pdfjs.getDocument({ data: buf }).promise;
    return pdf.numPages || 0;
  }

  async function extractPdfText(file) {
    if (!file) return "";
    const buf = await file.arrayBuffer();

    const pdfjs = getPdfjs();
    ensurePdfWorker(pdfjs);

    const pdf = await pdfjs.getDocument({ data: buf }).promise;
    const maxPages = pdf.numPages;

    let text = "";
    for (let p = 1; p <= maxPages; p++) {
      setStatus(`Extracting resume text… page ${p}/${maxPages}`, true);
      const page = await pdf.getPage(p);
      const content = await page.getTextContent();
      const strings = content.items.map((it) => it.str || "");
      text += strings.join(" ") + "\n";
    }
    return text.trim();
  }

  // Resume page constraint
  const RESUME_MIN_PAGES = 1;
  const RESUME_MAX_PAGES = 2;

  // ==========================
  // Courses (max 6) + whitelist
  // ==========================
  const MAX_COURSES = 6;
  const markedCourses = [];
  let COURSE_DB = null; // Set<string>

  async function loadCourseDB() {
    try {
      const res = await fetch("./course_whitelist.json", { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      const codes = Array.isArray(data.codes) ? data.codes : [];
      COURSE_DB = new Set(codes.map((s) => String(s).trim().toUpperCase()));
    } catch (e) {
      COURSE_DB = null;
      console.warn("Failed to load course whitelist:", e);
    }
  }

  function normalizeCourseCode(s) {
    let t = String(s || "").trim().toUpperCase();
    t = t.replace(/^MATH(UN|GU|GR|BC)(\d{4})$/, "MATH $1$2");
    t = t.replace(/^MATH\s+(UN|GU|GR|BC)(\d{4})$/, "MATH $1$2");
    t = t.replace(/\s+/g, " ");
    t = t.replace(/^MATH\s+(UN|GU|GR|BC)\s+(\d{4})$/, "MATH $1$2");
    return t;
  }

  function isGraduateMath(code) {
    return /^MATH\s+GR[56]\d{3}$/.test(code);
  }

  function renderCourses() {
    const wrap = el("courseChips");
    if (!wrap) return;

    wrap.innerHTML = "";
    markedCourses.forEach((c, idx) => {
      const chip = document.createElement("div");
      chip.className = "chip";
      chip.innerHTML = `
        <span>${c}</span>
        <button type="button" aria-label="Remove ${c}" title="Remove">×</button>
      `;
      chip.querySelector("button").addEventListener("click", () => {
        markedCourses.splice(idx, 1);
        renderCourses();
        disableUI(false);
      });
      wrap.appendChild(chip);
    });

    const note = el("courseCountNote");
    if (note) note.textContent = `${markedCourses.length} / ${MAX_COURSES} courses marked.`;

    const btn = el("btnMarkCourse");
    if (btn) btn.disabled = markedCourses.length >= MAX_COURSES;
  }

  function showCourseError(msg) {
    const box = el("courseErr");
    if (!box) return;
    box.style.display = "block";
    box.textContent = msg;
  }

  function clearCourseError() {
    const box = el("courseErr");
    if (!box) return;
    box.style.display = "none";
    box.textContent = "";
  }

  function wireMarkCourseButton() {
    const btnMark = el("btnMarkCourse");
    if (!btnMark) return;

    btnMark.addEventListener("click", () => {
      clearCourseError();

      const input = el("courseInput");
      const code = normalizeCourseCode(input ? input.value : "");

      if (!code) return showCourseError("Enter a course code first (example: MATH GU4061).");
      if (markedCourses.length >= MAX_COURSES) return showCourseError("You’ve already marked the maximum of 6 courses.");
      if (markedCourses.includes(code)) return showCourseError("That course is already marked.");

      // accept ONLY if whitelist OR graduate MATH GR5xxx/6xxx
      if (!isGraduateMath(code)) {
        if (!COURSE_DB) return showCourseError("Course database failed to load. Only MATH GR5xxx/6xxx can be marked right now.");
        if (!COURSE_DB.has(code)) return showCourseError("Not found in the Mathematics bulletin. Only listed courses or MATH GR5xxx/6xxx are counted.");
      }

      markedCourses.push(code);
      if (input) input.value = "";
      renderCourses();
      disableUI(false);
    });
  }

  // ==========================
  // Pool calibration (optional)
  // ==========================
  async function loadPoolRawScores(file, model) {
    if (!file) return null;
    const text = await file.text();
    const lines = text.split(/\r?\n/).map((s) => s.trim()).filter(Boolean);
    const rawAll = [];
    for (const line of lines) {
      try {
        const obj = JSON.parse(line);
        if (!obj || !Array.isArray(obj.features)) continue;
        const raw = PMERanker.scoreRaw(model, obj.features.map(Number));
        rawAll.push(raw);
      } catch {}
    }
    return rawAll.length ? rawAll : null;
  }

  // ==========================
  // Eligibility label
  // ==========================
  function readinessLabel(calcScore, gpa, courseCount) {
    const g = Number(gpa);
    const gpaOK = Number.isFinite(g) && g >= 3.4;
    if (calcScore === 10 && gpaOK && courseCount >= 2) return "Likely eligible";
    if (calcScore === 10 && gpaOK) return "Possibly eligible";
    return "Likely not eligible";
  }

// ==========================
// Main scoring click
// ==========================
function wireScoreButton() {
  const btnScore = el("btnScore");
  if (!btnScore) return;

  // IMPORTANT: overwrite any old handlers (prevents “ghost” old versions sending)
  btnScore.onclick = async () => {
    disableUI(true);

    try {
      clearOut();
      setStatus("Loading model…", true);

      // ---- Pull form fields ----
      const fullName = (el("fullName")?.value || "").trim();

      const uniCheck = validateUNI();
      const emailCheck = validateEmail();
      const uni = uniCheck.value;
      const email = emailCheck.value;

      const schoolYearText = (el("schoolYearText")?.value || "").trim();
      const raceEth = (el("raceEth")?.value || "").trim();

      const gpa = PMEFeatures.safeNum(el("gpa")?.value, NaN);
      const calcVal = el("calc")?.value;

      const resumeEl = el("resume");
      const resumeFile = resumeEl?.files?.[0] || null;

      // ✅ Essays: read ONLY from textarea IDs, NO renaming
      // Send verbatim (no trim) so Sheets matches what the user typed.
      const essayMath = (el("essayMath")?.value ?? "");
      const essayCommunity = (el("essayCommunity")?.value ?? "");

      // Word counts can be computed on the verbatim text
      const essayMath_words = wordCount(essayMath);
      const essayCommunity_words = wordCount(essayCommunity);

      const poolEl = el("poolFile");
      const poolFile = poolEl?.files?.[0] || null;

      // ---- Validation ----
      const flags = [];
      if (!fullName) flags.push("Missing full name");

      if (!uni) flags.push("Missing UNI");
      if (uniCheck.bad) flags.push("UNI must be ≤ 10 characters, contain no spaces, and must not include '@'.");

      if (!email) flags.push("Missing email");
      if (!emailCheck.ok) flags.push("Email must end with @columbia.edu or @barnard.edu.");

      if (!schoolYearText) flags.push("Missing School + Year");
      if (!Number.isFinite(gpa)) flags.push("Missing/invalid GPA");
      if (!calcVal) flags.push("Missing Calc I/II selection");
      if (!resumeFile) flags.push("Missing resume PDF");
      if (markedCourses.length === 0) flags.push("Mark at least 1 advanced/recent math course (up to 6).");

      // Essays must be non-empty
      if (!String(essayMath).trim()) flags.push("Missing Short Answer A");
      if (!String(essayCommunity).trim()) flags.push("Missing Short Answer B");

      // Backup word-limit checks (you can keep your hard-cap typing too)
      const maxA = getMaxWords(el("essayMath"), 250);
      const maxB = getMaxWords(el("essayCommunity"), 250);
      if (essayMath_words > maxA) flags.push(`Short Answer A exceeds ${maxA} words (${essayMath_words}).`);
      if (essayCommunity_words > maxB) flags.push(`Short Answer B exceeds ${maxB} words (${essayCommunity_words}).`);

      if (flags.length) {
        showOutError(flags);
        setStatus("Missing inputs.", false);
        return;
      }

      // ---- Resume page count ----
      setStatus("Checking resume length…", true);
      const pages = await getPdfPageCount(resumeFile);
      if (pages < RESUME_MIN_PAGES || pages > RESUME_MAX_PAGES) {
        showOutError([`Please upload a resume PDF that is ${RESUME_MIN_PAGES}–${RESUME_MAX_PAGES} pages (yours is ${pages}).`]);
        setStatus(`Resume must be ${RESUME_MIN_PAGES}–${RESUME_MAX_PAGES} pages.`, false);
        return;
      }

      // ---- Scoring pipeline ----
      const model = await PMERanker.loadModel();

      setStatus("Extracting resume…", true);
      const resumeText = await extractPdfText(resumeFile);

      setStatus("Building features…", true);
      const features = PMEFeatures.buildFeatures({
        gpa,
        calcVal,
        courses: markedCourses,
        resumeText,
        // features.js expects essayMath + essayComm
        essayMath: String(essayMath),
        essayComm: String(essayCommunity)
      });

      setStatus("Scoring…", true);
      const raw = PMERanker.scoreRaw(model, features);

      let poolRaw = null;
      if (poolFile) {
        setStatus("Calibrating vs pool…", true);
        poolRaw = await loadPoolRawScores(poolFile, model);
      }

      const score_0_10 = PMERanker.percentileScore(raw, poolRaw || [raw]);
      const readiness = readinessLabel(PMEFeatures.scoreCalc(calcVal), gpa, markedCourses.length);

      // ---- Render ----
      renderScore(out, { score_0_10, readiness, raw, poolRaw, gpa, calcVal, pages, resumeChars: resumeText.length });

      // ---- Save (THIS is the critical part) ----
      setStatus("Saving…", true);

      const payload = {
        fullName,
        uni,
        email,
        schoolYearText,
        raceEth,

        gpa: Number(gpa),
        calcVal: String(calcVal),
        courses: [...markedCourses],

        // ✅ EXACT keys that match textarea IDs (verbatim)
        essayMath,
        essayCommunity,
        essayMath_words,
        essayCommunity_words,

        score_0_10: Number(score_0_10.toFixed(6)),
        raw: Number(raw.toFixed(6)),
        feature_version: PMEFeatures.FEATURE_VERSION,
        features,

        resume_chars: resumeText.length,
        created_at_iso: new Date().toISOString()
      };

      // Debug once: confirm keys exist BEFORE sending
      console.log("[DEBUG] sending keys:", Object.keys(payload));
      console.log("[DEBUG] essayMath_len:", payload.essayMath.length, "essayCommunity_len:", payload.essayCommunity.length);

      await saveSubmissionToSheet(payload);

      setStatus("Done.", true);
    } catch (e) {
      console.error(e);
      showOutError([e?.message || "unknown error"]);
      setStatus("Error.", false);
    } finally {
      disableUI(false);
      updateScoreButtonEnabled();
    }
  };
}

  // ==========================
  // Reset
  // ==========================
  function wireResetButton() {
    const btnReset = el("btnReset");
    if (!btnReset) return;

    btnReset.type = "button";

    btnReset.addEventListener("click", (ev) => {
      ev.preventDefault();

      // Clear simple fields
      const ids = [
        "fullName", "uni", "email", "schoolYearText",
        "raceEth", "gpa", "calc",
        "essayMath", "essayCommunity",
        "courseInput"
      ];

      ids.forEach((id) => {
        const node = el(id);
        if (!node) return;
        if (node.tagName === "SELECT") node.selectedIndex = 0;
        else node.value = "";
      });

      // Clear file inputs
      ["resume", "poolFile"].forEach((id) => {
        const node = el(id);
        if (node) node.value = "";
      });

      // Clear courses
      markedCourses.splice(0, markedCourses.length);
      renderCourses();
      clearCourseError();

      // Clear status + output
      setStatus("", true);
      clearOut();

      // Refresh notes under textareas (no counter IDs)
      updateTextareaNote(el("essayMath"));
      updateTextareaNote(el("essayCommunity"));

      // Re-run validation visuals + button state
      validateUNI();
      validateEmail();
      updateScoreButtonEnabled();

      // Ensure mark/score enabled state recalculates
      disableUI(false);
    });
  }

  // ==========================
  // Init (runs once)
  // ==========================
  async function init() {
    // Word limits + note updates (no counter IDs)
    wireWordLimit("essayMath");
    wireWordLimit("essayCommunity");

    // UNI/email live validation + score enabled gating
    wireUniEmailValidation();

    // Courses
    await loadCourseDB();
    renderCourses();
    wireMarkCourseButton();

    // Buttons
    wireScoreButton();
    wireResetButton();

    // initial state
    validateUNI();
    validateEmail();
    updateScoreButtonEnabled();
    setStatus("", true);
    disableUI(false);
  }

  // If script loads before DOM (rare), wait.
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }
})();
</script>

<script>
  // ==========================
  // Live validation: UNI + Email (hard gate)
  // ==========================

  function setFieldError(node, on){
    if (!node) return;
    node.style.borderColor = on ? "rgba(220,38,38,.85)" : "";
    node.style.boxShadow   = on ? "0 0 0 3px rgba(220,38,38,.18)" : "";
  }

  function validateUNI(){
    const uniEl = el("uni");
    if (!uniEl) return { ok: true, value: "", bad: false };

    const raw = String(uniEl.value || "");

    // ✅ red-flag IMMEDIATELY if they type ANY whitespace anywhere (including trailing)
    const hasSpace = /\s/.test(raw);

    const v = raw.trim(); // keep trimmed value for storage/scoring

    // ❌ invalid if: >10 chars OR contains @ OR contains whitespace
    const bad = (v.length > 10) || v.includes("@") || hasSpace;

    // ✅ show red if they typed anything OR if whitespace happened
    const showRed = (raw.length > 0) && (bad || hasSpace);

    setFieldError(uniEl, showRed);

    return { ok: (v.length > 0) && !bad, value: v, bad };
  }

  function validateEmail(){
    const emailEl = el("email");
    if (!emailEl) return { ok: true, value: "", bad: false };

    const v = String(emailEl.value || "").trim().toLowerCase();

    // Must end with Columbia/Barnard domain
    const okDomain = v.endsWith("@columbia.edu") || v.endsWith("@barnard.edu");

    // also require an @ and no spaces
    const hasAt = v.includes("@");
    const hasSpace = /\s/.test(v);

    // bad only once they type something
    const bad = (v.length > 0) && (!okDomain || !hasAt || hasSpace);

    setFieldError(emailEl, bad);

    return { ok: (v.length > 0) && okDomain && hasAt && !hasSpace, value: v, bad };
  }

  function updateSubmitGate(){
    const uniCheck = validateUNI();
    const emailCheck = validateEmail();

    // Gate ONLY the scoring/submit button (btnScore).
    // We do NOT disable reset/mark-course because that gets annoying.
    const btn = el("btnScore");
    if (!btn) return;

    // Disable if either invalid
    btn.disabled = !(uniCheck.ok && emailCheck.ok);

    // Optional: status hint when blocked
    const s = el("status");
    if (s && btn.disabled) {
      s.textContent = "Enter a valid UNI + Columbia/Barnard email to submit.";
      s.classList.add("muted");
    }
  }

  // Wire live listeners
  (function wireUniEmailValidation(){
    const uniEl = el("uni");
    const emailEl = el("email");

    if (uniEl){
      uniEl.addEventListener("input", updateSubmitGate);
      uniEl.addEventListener("blur", updateSubmitGate);
    }
    if (emailEl){
      emailEl.addEventListener("input", updateSubmitGate);
      emailEl.addEventListener("blur", updateSubmitGate);
    }

    // run once on load so the button starts gated
    updateSubmitGate();
  })();

  // ==========================
  // Add to your btnScore click handler (hard stop)
  // ==========================
  // Inside btnScore.addEventListener("click", async () => { ... })
  // REPLACE:
  //   const uni = (el("uni")?.value || "").trim();
  //   const email = (el("email")?.value || "").trim();
  //
  // WITH:
  //   const uniCheck = validateUNI();
  //   const emailCheck = validateEmail();
  //   const uni = uniCheck.value;
  //   const email = emailCheck.value;
  //
  // And AFTER `const flags = [];` add:
  //   if (!uni) flags.push("Missing UNI");
  //   if (uniCheck.bad) flags.push("UNI must be ≤ 10 characters, contain no spaces, and must not contain '@'.");
  //   if (!email) flags.push("Missing email");
  //   if (!emailCheck.ok) flags.push("Email must be @columbia.edu or @barnard.edu (no spaces).");
  //
  // And BEFORE you proceed to scoring, add a hard stop:
  //   if (!(uniCheck.ok && emailCheck.ok)) {
  //     setStatus("Fix UNI/email before submitting.", false);
  //     disableUI(false);
  //     return;
  //   }
</script>
</body>
</html>